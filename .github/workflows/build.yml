name: Build & Publish CSS

on:
  release:
    types: [published]

jobs:
  build-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Build SCSS
        run: |
          mkdir -p dist
          npx sass scss/light.scss dist/light.css --style=compressed
          npx sass scss/dark.scss dist/dark.css --style=compressed
          npx sass scss/auto.scss dist/auto.css --style=compressed

      - name: Upload light.css
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: dist/light.css
          asset_name: light.css
          asset_content_type: text/css
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Upload dark.css
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: dist/dark.css
          asset_name: dark.css
          asset_content_type: text/css

      - name: Upload auto.css
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: dist/auto.css
          asset_name: auto.css
          asset_content_type: text/css

      - name: Update README version
        run: |
          latest_tag=$(echo "${GITHUB_REF_NAME}" | sed 's/^v//')
          sed -E -i "s/orthocss@[0-9]+\.[0-9]+\.[0-9]+/orthocss@${latest_tag}/g" README.md

      - name: Create pull request
        uses: peter-evans/create-pull-request@v7
        with:
          sign-commits: true
          commit-message: 'Update CDN version in README'
          delete-branch: true
          title: 'Update CDN version in README'
          branch: update-readme
          base: master
